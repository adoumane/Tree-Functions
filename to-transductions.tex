\newcommand{\Root}[1]{\mathsf{root}_{#1}}
\newcommand{\Port}[1]{\mathsf{port}_{#1}}
\newcommand{\Interface}[1]{\mathsf{Interface}_{#1}}
\section{To transductions}
\label{sec:to-transductions}
In this section, we prove the right-to-left implication in Theorem~\ref{thm:main}, namely that if $\rSigma,\rGamma$ are finite ranked sets and 
\begin{align*}
    \ranked {f : \tmonad \Sigma \to \tmonad \Gamma} 
\end{align*}
is a first-order term function, then its restriction to trees 
\begin{align*}
    f : \trees \rSigma \to \trees \rGamma
\end{align*}
is a first-order tree-to-tree transduction. The proof is a relatively straightforward induction on the way that $\ranked f$ is constructed from the atomic functions using the combinators. Recall that first-order tree-to-tree transductions were defined by applying the notion of first-order transduction (Definition~\ref{def:fo-transduction}) to models associated to trees (Definition~\ref{def:tree-model}). To apply first-order transductions to more complicated types, such as terms, pairs of terms, tensors of terms of pairs, etc, we need to explain how those types are modeled as relational structures; this is done in the following definition. 


% We do this by assigning to each element $a$ in a type $\rSigma$ an associated model $\underline a$. 
% \newcommand{\structa}{\mathfrak A}
% When defining the models below, we use two types of disjoint union. 
% \begin{itemize}
%     \item For two relational structures $\structa_1,\structa_2$ over relational vocabularies $\ranked{\tau_1},\ranked{\tau_2}$, define $\structa_1 + \structa_2$ to be the  relational structure over vocabulary $\ranked{\tau_1 + \tau_2}$ defined by taking the disjoint union of the structures, and interpreting the relations of $\structa_i$ using the copy $\ranked{\tau_i}$ of the vocabulary.
%     \item For a family of $\set{\structa_i}_{i \in I}$ of relational structures over a common vocabulary $\ranked \tau$, define $\coprod_i \structa_i$ to be the structure over $\ranked \tau$ disjoint union of the structures, with all components using the common vocabulary.
% \end{itemize}


\begin{definition}[Associated models for terms, pairs, co-pairs and tensors.] Let $\rSigma$ be a type, as per Definition~\ref{def:types}.  Figure~\ref{fig:vocmodels} shows how we associate  to each $a \in \rSigma$ a model $\underline a$, which is a relational structure. The vocabulary of this relational structure, call it $\voctype \rSigma$, depends only  on $\rSigma$. The associated model is additionally equipped  with a distinguished sequence of elements called \emph{ports};  the number of ports is the arity of $a$.   
\end{definition}


\newcommand{\vocline}[3]{\\ $#1$ & $#2$ & \begin{minipage}{0,6\textwidth}
    #3
\end{minipage}\\}

\begin{figure}
    \begin{tabular}{l|l|l}
        type $\rSigma$ & vocabulary $\voctype \rSigma$ & associated model $\underline a$ for $a \in \rSigma$ of arity $n$ \\ \hline
        \vocline
        {
            \set{a_1,\ldots,a_k}
            }  
        {
            \set{\overbrace{a_1,\ldots,a_k,P_1,P_2,\ldots}^{\text{unary relations}}}
        }    
        {
         Let $a \in \rSigma$.   The universe of $\underline a$ is 
            \begin{align*}
               \set{0,\underbrace{1,2,\ldots,n}_{\text{ports}}}.
            \end{align*}
            The  relation $P_i$  is interpreted as $\set i$ when $i \in \set{1,\ldots,n}$ and as the empty set otherwise. The relation $a_i$ is interpreted as $\set 0$ when $a = a_i$ and as the empty set otherwise.  The ports are $1,\ldots,n$.
        }
        \vocline
        {
            \ranked{\Sigma_1 + \Sigma_2}
            }  
        {
            \ranked{\voctype \Sigma_1 + \voctype \Sigma_2}
        }    
        {
            For $a =(i,a_i)$, the associated model  is obtained by taking $\underline{a_i}$, viewed as a model over $\ranked{\voctype{\Sigma_i}}$, and  interpreting the remaining relations in $\ranked{\voctype \Sigma_1 + \voctype \Sigma_2}$  as empty sets.  The ports are inherited from  $\underline {a_i}$.
        }
        \vocline
        {
            \ranked{\Sigma_1 \otimes \Sigma_2}
            }  
        {
            \ranked{\voctype \Sigma_1 + \voctype \Sigma_2}
        }    
        {
            For  $ a =\tensorpair{a_1,a_2}$, the associated model is    the disjoint union $\underline{a_1} + \underline {a_2}$, with the relations of $\underline {a_1}$ using the    $\voctype{\ranked{\Sigma_1}}$  part of the vocabulary, and the relations of $\underline {a_2}$ using the the    $\voctype{\ranked{\Sigma_1}}$  part of the vocabulary. 
            If $n_1$ is the arity of $a_1$, then the first $n_1$ ports are inherited from  $\underline {a_1}$ and the remaining ports are inherited from  $\underline {a_2}$.
        }
        \vocline
        {
            \ranked{\Sigma_1 \times \Sigma_2}
            }  
        {
            \ranked{\voctype \Sigma_1 + \voctype \Sigma_2} + \overbrace{\set R}^{\text{binary}}
        }    
        {
            For  $ a =(a_1,a_2)$, the associated model is      the disjoint union $\underline{a_1} +  \underline {a_2}$, in the same sense as in the previous item for $\otimes$,  with $R$ interpreted as 
            \begin{align*}
                \set{(\text{$i$-th port of $\underline {a_1}$}, \text{$i$-th port of $\underline a_2$}): i \in \set{1,\ldots,n}} 
            \end{align*}
            The ports are inherited from   $\underline {a_1}$.
        }
        \vocline
        {
            \ranked{\tmonad \rSigma}
            }  
        {
            \voctype \rSigma + \overbrace{\set <}^{\text{binary}}
        }    
        {
            Let $a \in \tmonad \rSigma$. Consider the structure
            \begin{align*}
                 \coprod_{x} \underline{a(x)}
            \end{align*}
            where $x$ ranges  over  (port or non-port) nodes $x$ in $a$. In the above, $\underline a(x)$ is a structure over vocabulary $\voctype \rSigma$ that  is defined by induction assumption for non-port nodes, and otherwise has a single element with all relations empty.  The disjoint union $\coprod$ uses the same vocabulary $\voctype \rSigma$ for all structures in the disjoint union.  The binary relation $<$ consists of all pairs $(u,v)$ such that $u$ is the $i$-th port of $\underline{a(x)}$  some non-port node $x$, and $v$ belongs to $\underline{a(y)}$ for some node (possibly a port) $y$ which is a descendant (not necessarily proper) of the $i$-th child of $x$.
            The $i$-th port is the unique node in $\underline {a(x)}$, where $x$ is the $i$-th port of $a$.
        }
    \end{tabular}
    \caption{\label{fig:vocmodels}
     Associated models for elements of the types.}
\end{figure}

  
\begin{lemma}
    For every first-order term function $\ranked f$, there is a first-order term interpetation 
\end{lemma}


