
\section{First-order term functions can be described in logic}
\label{sec:to-logic}
We show in this section that first-order tree-to-tree functions can be implemented by first-order transductions.

\begin{proposition}\label{prop:to-logic} If $f : \rSigma \to \rGamma$ can be derived from the atomic functions using combinators, then there is a first-order transduction $g$ 
    which makes the following diagram commute
    \begin{align*}
        \xymatrix@C=3cm{
            \rSigma \ar[d]_{a \mapsto \underline a}\ar[r]^f &  \rGamma \ar[d]^{a \mapsto \underline a} \\
            \text{relational structures over $\voctype \rSigma$} \ar[r]_g &  \text{relational structures over $\voctype \rGamma$}.
        } 
    \end{align*}    
\end{proposition}
    
    \begin{proof}
    The proof is by induction, following the definition of first-order tree-to-tree functions. The basic functions with finite domain, projections, co-projections and distribution laws are easily definable by first-order transductions.  
    
    In the following, it will be convenient to use, as part of the vocabulary $\voctype \rSigma$ of every type $\rSigma$, the unary relation  $\mathsf{Port}_\Sigma$ which selects the ports of the structures over $\voctype\rSigma$; and the binary relation $\sqsubseteq_\Sigma$ which orders these ports. By induction on $\rSigma$, both relations can be defined by first-order formulas over  $\voctype \rSigma$.
    
    \begin{enumerate}
    \item $\unit_\rSigma$. Given an element $x$ of $\Sigma$, let us show how the fucntion $\unit_\rSigma(x)$ can be implemented using an fo transduction.  The copying constant is 2,
    the first copy will contain the whole structure $\underline{x}$ and the second copy will select only the ports of $\underline{x}$ which will serve as the ports of the structure $\underline{\unit_\rSigma(x)}$.  The universe formulas are then:
    \begin{align*}
    \varphi_1(x)=\mathsf{true} \qquad \varphi_2(x)=\mathsf{Port}_\Sigma(x)
    \end{align*}
    In the first copy, the vocabulary $\voctype \rSigma$ will be interpreted as in the original structure, and as the empty set in the second one. That is, for every unary relation $R\in \voctype \rSigma$ and for every binary relation $S \in \voctype \rSigma$, we set:
    \begin{align*}
   \varphi_R^{1}(x)=R(x) \quad&\quad \varphi_S^{1,1}(x,y)=S(x,y)\\
   \varphi_R^{2}(x)=\mathsf{False} \quad&\quad \varphi_S^{2,2}(x,y)=\mathsf{False}
\end{align*}      
Let us interpret the relations $<$ and $\sqsubseteq$ of $\voctype \tmonad\rSigma$. The  ports of $\underline{\unit_\rSigma(x)}$ inherit the order of the ports of $\underline{x}$, this is why we set:
\begin{align*}
\varphi_\sqsubseteq^{2,2}(x,y)=x\sqsubseteq_\Sigma y
\end{align*}
The descendent relation $<$ connects the $i^{th}$ port of $\underline{x}$ to the $i^{th}$ port of $\underline{\unit_\rSigma(x)}$. Since these nodes come from the same node in the original structure, we set:
\begin{align*}
\varphi_<^{1,2}(x,y)=x=y
\end{align*}
    \end{enumerate}
    
       \end{proof}
   If $k$ is an integer, we set $\mathsf{Mon}^k$ to be the monoid whose ground set is 
   \begin{align*}
   \{f:[1,k]\to [1,k] \ | f \text{ is monotonic}\}
\end{align*}    

and whose multiplication is functions composition.  The elements of $\mathsf{Mon}^k$ can be represented graphically as:
     

We show that the monoid $\mathsf{Mon}^k$ is aperiodic.
     \begin{proposition}\label{prop:MonIsFo}
Given an integer $k$, the monoid $\mathsf{Mon}^k$ is aperiodic.     
     \end{proposition}
     
     \begin{proof}
     Let $f$ be an element of $\mathsf{Mon}^k$. We define \emph {its graph} as the directed graph whose vertices are $\set{1,\dots, k}$, and which contains an edge $i\rightarrow j$ if $f(i)=j$. Note that the out-degree of the nodes is 1. To show Proposition~\ref{prop:MonIsFo}, we start by extracting some properties of these graphs.
     
The first one is that the weakly connected components of these graphs are intervals. With this property, we can treat only the graphs with only one weakly connected component, since those are independent. 
     \begin{lemma}
     If $f$ is an element of $\mathsf{Mon}^k$ and $I\subseteq \set{1,\dots,k}$ is a weakly connected component of the graph of $f$, then $I$ is an interval. 
     \end{lemma}
     
     \begin{lemma}
     If $f$ is an element of $\mathsf{Mon}^k$ whose graph is weakly connected, then 
\begin{itemize}
\item there is a node $n$  having a self loop in $G$,
\item there is a directed path from any node of $G$ to $n$. 
\end{itemize}     
 We call $n$ the \emph{attractor} of $f$.    
     \end{lemma}  
    
    \begin{lemma}
    Let $f$ be an element of $\mathsf{Mon}^k$.  If there is a directed path of lenght $p$ from $m$ to $n$ in the graph of $f$, the there is a directed path of lenght $1$ from $m$ to $n$ in the graph of $f^p$.
    \end{lemma}
     \end{proof}