\section{The matrix power}

\newcommand{\mati}[2]{#2^{\ranked{[#1]}}}
\newcommand{\branches}{\mathsf{B}}

For a ranked set $\rSigma$ and $k \in \set{1,2,\ldots}$ define its $k$-th matrix power 
to be the set
\begin{align*}
    \mati k \rSigma \quad \eqdef \quad \ranked{\reduce k \rSigma^k}.
\end{align*}
The key definition of this section is term unfolding, is an operation 
\begin{align*}
    \ranked{\unfold : \tmonad \mati k \rSigma \to \mati k {(\tmonad \Sigma)} }
    \end{align*}
that is illustrated in the  following picture for  $k=2$  and explained in Definition~\ref{def:term-unfolding}:
\mypic{39}
\begin{definition}[Shallow unfolding and term unfolding]\label{def:term-unfolding}
    Define shallow unfolding 
        \begin{align*}
        \ranked{\unfold : \shallowterm{\mati k \Sigma}{\mati k \Gamma} \to \mati k {(\shallowterm \Sigma \Gamma)}}
        \end{align*}        
to be the composition of the following operations:
\begin{center}
    todo
\end{center}
% \begin{align*}
% \ranked{
%     \xymatrix{
%         \shallowterm{\reduce k {\Sigma^k}}{\Gamma} \ar[r] & (\shallowterm \Sigma \Gamma)^k 
%     }
% }
% \end{align*}
Define term unfolding to be the operation
\begin{align*}
    \ranked{\unfold : \tmonad \mati k \rSigma \to \mati k {(\tmonad \Sigma)} }
    \end{align*}
which recursively applies shallow unfolding in the following sense.
\begin{center}
    todo
\end{center}
\end{definition}

In general, the term unfolding operation is not derivable, but it will become derivable after imposing a monotonicity requirement.   To see the need for monotonicity, consider the following example.
\begin{example}
    todo
\end{example}

\paragraph{Monotone matrix power.}
The monotonicity requirement is essentially the same as monotonicity in register updates of register transducers, see Definition~\ref{def:stt}. 
For a ranked set $\rSigma$, define its \emph{branches} to be the unranked set (hence the black font):
\begin{align*}
\branches \rSigma \quad \eqdef \quad \set{(a,i) : a \in \rSigma, i \in \set{1,\ldots,\arity a}}.
\end{align*}
For $a \in  \rSigma$, a branch in $a$ is defined to be any branch obtained by choosing some port of $a$. 
We draw branches like this:
\mypic{82}
Define the \emph{twist function} on branches of the matrix power 
\begin{align*}
\mathrm{twist} : \branches \reduce k \ranked{\Sigma^k}  \to (\set{1,\ldots,k} \to \set{1,\ldots,k})
\end{align*}
to be the function illustrated in the following picture:
\begin{center}
    todo
\end{center}

\begin{definition}
    [Monotone matrix power] \label{def:monotone-matrix-power} We say that an element of the $k$-matrix power is \emph{monotone} if all of its branches have monotone twist.
\end{definition}
 We are now ready to state the principal result of this section.

\begin{lemma}\label{lem:monotone-unfold}
    For every finite ranked set $\rSigma$ and every $k \in \set{1,2,\ldots}$ there is a derivable function 
    \begin{align*}
    \ranked{ f : \tmonad \mati k \Sigma \to \mati k {(\tmonad \Sigma)}}
    \end{align*}
    which coincides with term unfolding for monotone inputs.
\end{lemma}

Our proof strategy is to show that term unfolding can be derived for certain homogeneous (see below) monotone inputs, and then to show that every input can be decomposed into simpler inputs in a homogeneous way. The notion of homogeneous inputs, and the result about  decomposing of arbitrary inputs into homogeneous inputs, are presented in Section~\ref{sec:factfor}. Next, in Section~\ref{sec:homo-unfold}, we show how term unfolding can be done for homogeneous inputs. Finally, in Section~\ref{sec:monotone-unfold-proof} we prove Lemma~\ref{lem:monotone-unfold} by combining  the results of Sections~\ref{sec:factfor} and~\ref{sec:homo-unfold}.

\input{factfor}
\input{homo-unfold}

\subsection{Proof of Lemma~\ref{lem:monotone-unfold}}
\label{sec:monotone-unfold-proof}
In this section, we complete the proof of Lemma~\ref{lem:monotone-unfold}. 